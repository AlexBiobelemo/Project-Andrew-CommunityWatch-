{% extends "base.html" %}

{% block content %}
<div class="container mt-4 form-page-container">
    <div class="row">
        <div class="col-md-8">
            <h2>{{ issue.category }}</h2>
            <p class="text-muted">Reported by {{ issue.reporter.username }} on {{ issue.timestamp.strftime('%Y-%m-%d') }}</p>
            <p>{{ issue.description }}</p>

            {% if issue.image_filename %}
                <div class="my-3">
                    <img src="{{ url_for('main.uploaded_file', filename=issue.image_filename) }}" class="img-fluid rounded" alt="Issue image">
                </div>
            {% endif %}

            <hr>

            <h4>Comments</h4>
            {% for comment in comments %}
                <div class="card mb-2">
                    <div class="card-body">
                        <p>{{ comment.body }}</p>
                        <small class="text-muted">By {{ comment.author.username }} on {{ comment.timestamp.strftime('%Y-%m-%d') }}</small>
                    </div>
                </div>
            {% endfor %}

            <hr>
            <h4>Add Your Comment</h4>
            <form action="" method="post" novalidate>
                {{ form.hidden_tag() }}
                <div class="mb-3">
                    {{ form.body(class="form-control", rows="3") }}
                </div>
                {{ form.submit(class="btn btn-primary") }}
            </form>
        </div>

        <div class="col-md-4">
            <div id="issue-map" style="height: 200px;" class="mb-3"></div>
            <p><strong>Upvotes:</strong> {{ issue.upvote_count }}</p>
            <p><strong>Status:</strong> <span class="badge bg-info">{{ issue.status }}</span></p>

            {% if current_user.is_moderator %}
            <div class="card mt-4">
                <div class="card-header">Moderator Actions</div>
                <div class="card-body">
                    <form action="{{ url_for('main.update_status', issue_id=issue.id) }}" method="POST">
                        <div class="mb-3">
                            <label for="status" class="form-label">Update Status</label>
                            <select name="status" class="form-select">
                                <option value="Reported" {% if issue.status == 'Reported' %}selected{% endif %}>Reported</option>
                                <option value="In Progress" {% if issue.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                                <option value="Resolved" {% if issue.status == 'Resolved' %}selected{% endif %}>Resolved</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Update</button>
                    </form>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    var issueMap = L.map('issue-map').setView([{{ issue.latitude }}, {{ issue.longitude }}], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(issueMap);
    L.marker([{{ issue.latitude }}, {{ issue.longitude }}]).addTo(issueMap);
</script>
{% endblock %}