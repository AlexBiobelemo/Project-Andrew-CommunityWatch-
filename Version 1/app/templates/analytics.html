{% extends "base.html" %}

{% block content %}
<div class="container mt-4 form-page-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Community Analytics</h1>
        <button class="btn btn-primary" id="generate-report-btn">
            <i class="bi bi-robot"></i> Generate Weekly Briefing
        </button>
    </div>

    <div id="report-container" class="card mb-4" style="display: none;">
        <div class="card-header">AI-Generated Weekly Briefing</div>
        <div class="card-body">
            <div id="report-spinner" class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div id="report-content"></div>
        </div>
    </div>

    <h3 class="mt-5">Issue Hotspots</h3>
    <div id="heatmap" style="height: 400px;" class="mb-4 rounded" data-points='{{ heatmap_data | tojson }}'></div>

    <h3 class="mt-5">Status Overview</h3>
    <div class="row">
        <div class="col-md-4">
            <div class="card text-white bg-danger mb-3">
                <div class="card-header">Reported</div>
                <div class="card-body">
                    <h5 class="card-title">{{ status_counts.get('Reported', 0) }}</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-warning mb-3">
                <div class="card-header">In Progress</div>
                <div class="card-body">
                    <h5 class="card-title">{{ status_counts.get('In Progress', 0) }}</h5>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-success mb-3">
                <div class="card-header">Resolved</div>
                <div class="card-body">
                    <h5 class="card-title">{{ status_counts.get('Resolved', 0) }}</h5>
                </div>
            </div>
        </div>
    </div>

    <h3 class="mt-5">Top 5 Unresolved Issues</h3>
    <ul class="list-group">
        {% for issue in top_issues %}
        <a href="{{ url_for('main.view_issue', issue_id=issue.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            {{ issue.category }}
            <span class="badge bg-primary rounded-pill">{{ issue.upvote_count }} Upvotes</span>
        </a>
        {% else %}
        <li class="list-group-item">No unresolved issues.</li>
        {% endfor %}
    </ul>
</div>

<script>
    // --- AI Report Generation Logic ---
    const generateBtn = document.getElementById('generate-report-btn');
    const reportContainer = document.getElementById('report-container');
    const reportContent = document.getElementById('report-content');
    const reportSpinner = document.getElementById('report-spinner');

    generateBtn.addEventListener('click', async () => {
        reportContainer.style.display = 'block';
        reportContent.innerHTML = '';
        reportSpinner.style.display = 'block';
        generateBtn.disabled = true;

        try {
            const response = await fetch("{{ url_for('main.generate_report') }}", { method: 'POST' });
            const responseText = await response.text();
            const data = JSON.parse(responseText);

            if(data.report) {
                reportContent.innerHTML = marked.parse(data.report);
            } else {
                reportContent.innerHTML = '<p class="text-danger">Failed to generate report.</p>';
            }

        } catch (error) {
            console.error('Error processing report:', error);
            reportContent.innerHTML = '<p class="text-danger">An error occurred. Check the console for details.</p>';
        } finally {
            reportSpinner.style.display = 'none';
            generateBtn.disabled = false;
        }
    });

    // --- Heatmap Initialization Logic ---
    document.addEventListener('DOMContentLoaded', () => {
        const heatmapDiv = document.getElementById('heatmap');
        const points = JSON.parse(heatmapDiv.dataset.points);

        if (points.length > 0) {
            const heatMap = L.map('heatmap').setView([4.9248, 6.2647], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(heatMap);

            // 1. Increased intensity for the heatmap layer
            L.heatLayer(points, {
                radius: 35,
                blur: 25,
                gradient: {0.5: 'green', 0.7: 'yellow', 0.9: 'orange', 1.0: 'red'}
            }).addTo(heatMap);

            // 2. Add circle highlights for each individual report
            points.forEach(function(point) {
                L.circle(point, {
                    radius: 20,
                    color: '#ff0000',
                    weight: 1,
                    fillColor: '#ff0000',
                    fillOpacity: 0.2
                }).addTo(heatMap);
            });

        } else {
            heatmapDiv.innerHTML = '<p class="text-center text-muted">No unresolved issues to display on the map.</p>';
        }
    });
</script>
{% endblock %}